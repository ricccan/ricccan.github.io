<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RSA Encryption & Frequency-Based Decoding</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px auto;
      max-width: 900px;
      background-color: #f7f9fb;
      color: #333;
      line-height: 1.6;
    }
    textarea {
      width: 100%;
      height: 120px;
      font-size: 1em;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: none;
      box-sizing: border-box;
    }
    button {
      margin: 8px 4px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background-color: #3498db;
      color: white;
      font-size: 1em;
      cursor: pointer;
    }
    button:hover {
      background-color: #2c82c9;
    }
    input[type="number"] {
      width: 80px;
      padding: 6px;
      margin-left: 8px;
    }
    #cipherOut, #plainOut, #decodeOut {
      background-color: #eef4fb;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }
    #keyInfo {
      background-color: #e3f7e3;
      padding: 8px;
      border-radius: 6px;
      margin: 10px 0;
      font-family: monospace;
    }
    canvas {
      background: white;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1>RSA Encryption & Frequency-based Decoder üîê</h1>

  <h3>Step 1: Generate RSA Keys</h3>
  <button onclick="generateKeys()">Generate Keys</button>
  <div id="keyInfo"></div>

  <h3>Step 2: Encrypt Text</h3>
  <textarea id="plainText" placeholder="Enter text to encrypt..."></textarea>
  <button onclick="encryptRSA()">Encrypt</button>
  <pre id="cipherOut"></pre>

  <h3>Step 3: Decrypt</h3>
  <button onclick="decryptWithPrivate()">Decrypt (private key)</button>
  <button onclick="attemptFactorAndDecode()">Attempt factor n ‚Üí compute d ‚Üí decrypt</button>
  <label>Max trial: <input type="number" id="maxTrial" value="10000"></label>
  <pre id="plainOut"></pre>

  <h3>Decoded Results / Analysis</h3>
  <pre id="decodeOut"></pre>
  <div id="scoreOut"></div>

  <canvas id="freqChart"></canvas>

  <script>
    // --- Utilities for BigInt math
    function modPow(base, exp, mod) {
      let result = 1n;
      base %= mod;
      while (exp > 0n) {
        if (exp % 2n === 1n) result = (result * base) % mod;
        exp /= 2n;
        base = (base * base) % mod;
      }
      return result;
    }
    function egcd(a, b) {
      if (b === 0n) return [a, 1n, 0n];
      const [g, x1, y1] = egcd(b, a % b);
      return [g, y1, x1 - (a / b) * y1];
    }
    function modInverse(a, m) {
      const [g, x] = egcd(a, m);
      return g !== 1n ? null : (x % m + m) % m;
    }

    // --- RSA
    let RSA = {};
    let lastCipher = null;
    let lastCandidatePlain = "";
    let lastCandidateFreq = {};
    const englishRef = {
      a:8.167,b:1.492,c:2.782,d:4.253,e:12.702,f:2.228,g:2.015,h:6.094,i:6.966,
      j:0.153,k:0.772,l:4.025,m:2.406,n:6.749,o:7.507,p:1.929,q:0.095,r:5.987,
      s:6.327,t:9.056,u:2.758,v:0.978,w:2.360,x:0.150,y:1.974,z:0.074
    };

    function generateKeys() {
      const primes = [101,103,107,109,113,127,131,137,139,149];
      const p = BigInt(primes[Math.floor(Math.random()*primes.length)]);
      let q;
      do { q = BigInt(primes[Math.floor(Math.random()*primes.length)]); } while (q===p);
      const n = p*q;
      const phi = (p-1n)*(q-1n);
      let e = 65537n;
      if (phi % e === 0n) e = 17n;
      const d = modInverse(e, phi);
      RSA = {p,q,n,e,d};
      document.getElementById('keyInfo').textContent =
        `p=${p}, q=${q}, n=${n}, phi=${phi}, e=${e}, d=${d}`;
    }

    function textToCodePoints(txt){return Array.from(txt).map(c=>c.charCodeAt(0));}
    function codePointsToText(arr){return arr.map(c=>String.fromCharCode(c)).join('');}

    function encryptRSA() {
      if (!RSA.n) { alert('Generate keys first'); return; }
      const cps = textToCodePoints(document.getElementById('plainText').value);
      const cipher = cps.map(cp => modPow(BigInt(cp), RSA.e, RSA.n));
      lastCipher = cipher.map(c => c.toString());
      document.getElementById('cipherOut').textContent = JSON.stringify(lastCipher);
    }

    function decryptWithPrivate() {
      if (!RSA.d || !RSA.n) { alert('Need private key (generate keys first)'); return; }

      // Se non c‚Äô√® lastCipher, prova a leggerlo dal <pre>
      if (!lastCipher) {
        try {
          const raw = document.getElementById('cipherOut').textContent.trim();
          if (raw.startsWith('[')) lastCipher = JSON.parse(raw);
          else throw new Error("Ciphertext non in formato JSON");
        } catch (err) {
          alert('No valid ciphertext found (encrypt first or paste a JSON array).');
          return;
        }
      }

      const nums = lastCipher.map(s => BigInt(s));
      const decCps = nums.map(c => Number(modPow(c, RSA.d, RSA.n)));
      const text = codePointsToText(decCps);
      document.getElementById('plainOut').textContent = text;
      lastCandidatePlain = text;
      lastCandidateFreq = getLetterFreqPercentFromText(text);
      renderChart(lastCandidateFreq, 'Decoded Text Letter Distribution');
    }

    function attemptFactorAndDecode() {
      // Prova a caricare ciphertext da campo se non gi√† presente
      if (!lastCipher) {
        try {
          const raw = document.getElementById('cipherOut').textContent.trim();
          if (raw.startsWith('[')) lastCipher = JSON.parse(raw);
          else throw new Error("Ciphertext non in formato JSON");
        } catch (err) {
          alert('No valid ciphertext found (encrypt first or paste a JSON array).');
          return;
        }
      }

      const n = RSA.n;
      if (!n) { alert('No n available. Generate keys first.'); return; }
      const maxTrial = parseInt(document.getElementById('maxTrial').value, 10) || 10000;
      const res = factorSmall(Number(n.toString()), maxTrial);
      if (!res) {
        document.getElementById('decodeOut').textContent = `Failed to factor n (trial up to ${maxTrial}). Increase maxTrial or use smaller n.`;
        return;
      }
      const {p,q} = res;
      const phi = BigInt(p-1) * BigInt(q-1);
      const d = modInverse(RSA.e, phi);
      if (!d) {
        document.getElementById('decodeOut').textContent = `Found factors p=${p}, q=${q} but e is not invertible mod phi.`;
        return;
      }

      const nums = lastCipher.map(s => BigInt(s));
      const decCps = nums.map(c => Number(modPow(c, d, RSA.n)));
      const text = codePointsToText(decCps);
      document.getElementById('decodeOut').textContent = `FACTORED: p=${p}, q=${q}\nComputed d=${d.toString()}\n\nDecoded candidate:\n\n${text}`;
      const freq = getLetterFreqPercentFromText(text);
      const score = mseBetween(freq, englishRef);
      document.getElementById('scoreOut').textContent = `MSE score vs English ref: ${score.toFixed(4)} (lower = closer)`;
      lastCandidatePlain = text;
      lastCandidateFreq = freq;
      renderChart(freq, 'Decoded (Factored) Distribution');
    }

    function factorSmall(n, limit){
      for (let i=2;i<=limit;i++){
        if (n % i === 0) return {p:i,q:n/i};
      }
      return null;
    }

    function getLetterFreqPercentFromText(text){
      const freq={}; let total=0;
      for(let i=97;i<=122;i++) freq[String.fromCharCode(i)]=0;
      for(let c of text.toLowerCase()){
        if(/[a-z]/.test(c)){freq[c]++; total++;}
      }
      for(let k in freq) freq[k]=total>0?(freq[k]/total)*100:0;
      return freq;
    }

    function mseBetween(f1,f2){
      let sum=0; for(let k in f1){const d=f1[k]-f2[k]; sum+=d*d;}
      return sum/Object.keys(f1).length;
    }

    let chartInstance=null;
    function renderChart(frequencies,title){
      const ctx=document.getElementById('freqChart').getContext('2d');
      if(chartInstance)chartInstance.destroy();
      chartInstance=new Chart(ctx,{
        type:'bar',
        data:{
          labels:Object.keys(frequencies).map(l=>l.toUpperCase()),
          datasets:[{
            label:'Frequency (%)',
            data:Object.values(frequencies),
            backgroundColor:'#3498db',
            borderRadius:4
          }]
        },
        options:{
          plugins:{
            title:{display:true,text:title,font:{size:18}},
            legend:{display:false}
          },
          scales:{
            y:{beginAtZero:true,title:{display:true,text:'%'}},
            x:{title:{display:true,text:'Letters'},grid:{display:false}}
          }
        }
      });
    }
  </script>
</body>
</html>
